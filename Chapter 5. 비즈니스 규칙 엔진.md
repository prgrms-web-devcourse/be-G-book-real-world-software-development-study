# Chapter 5. 비즈니스 규칙 엔진



## 5.1 목표

- 유닛 테스트(모킹 기법)
- 빌더 패턴
- 인터페이스 분리 원칙





## 5.2 요구 사항

> 비즈니스 규칙 엔진(한 개 이상의 비즈니스 규칙을 실행하는 SW)

- 팩트 : 규칙이 확인할 수 있는 정보
- 액션 : 수행하려는 동작
- 조건 : 액션을 언제 발생시킬지 지정
- 규칙 : 실행하려는 비즈니스 규칙을 지정





## 5.3 TDD

> 실제 코드를 구현하기 전에 테스트 코드를 먼저 구현한다.



**5.3.1 TDD 사용 이유**

- 테스트를 따로 구현하기 때문에 테스트에 대응하는 요구 사항을 한 개씩 구현할 때마다 **필요한 요구 사항에 집중하고 개선**할 수 있다.
- 코드를 올바르게 조직할 수 있다.
  - ex) 먼저 테스트를 구현하면서 코드에 **어떤 공개 인터페이스를 만들어야 하는지 신중히 검토**하게 된다.
- TDD 주기에 따라 요구 사항 구현을 반복하면서 종합적인 테스트 스위트를 완성할 수 있으므로 **요구 사항을 만족시켰다는 사실을 조금 더 확신**할 수 있으며 **버그 발생 범위도 줄일 수 있다.**
- 테스트를 통과하기 위한 코드를 구현하기 때문에 **필요하지 않은 테스트를 구현하는 일을 줄일 수 있다.**



**5.3.2 TDD 주기**

1. 실패하는 테스트 구현
2. 모든 테스트 실행
3. 기능이 동작하도록 코드 구현
4. 모든 테스트 실행





# 5.4 모킹

> run()이 실행되었을 때 확인하는 기법

- 비즈니스 규칙에 액션을 추가할 때마다 run()이 실행되었는지 확인한다.
- 모킹 라이브러리(모키토) 사용



**순서**

1. 목(mock) 생성
2. 메소드가 호출되었는지 확인





# 5.5 조건 추가하기

- 특정 조건을 만족하면 액션을 수행하도록 설정할 수 있어야 한다.



**5.5.1 상태 모델링**

- 비즈니스 규칙 엔진 내의 액션에서 사용할 수 있는 상태로 **캡슐화**해야 한다.
- 항상 처음에는 테스트가 실패했는지 확인해 우연히 통과하는 테스트를 만들지 말자.



**5.5.2 지역 변수 형식 추론**

- 코드를 쉽게 구현하는 것보다 쉽게 읽을 수 있느냐가 중요하다.

- 형식 추론 : 컴파일러가 정적 형식을 자동으로 추론해 결정하는 기능
- `Map<String, String> facts = new HashMap<>();` : 파라미터 형식을 안다면 파라미터 생략 가능
- var : 지역 변수로 가독성에 문제가 없다면 사용해도 좋다.



**5.5.3 switch 문**

- 거래 상태에 따라 거래 성사 가능성을 제공하는 규칙을 할당할 수 있다.
- 새로운 switch문을 사용해 break문을 사용하지 않고도 폴스루를 방지할 수 있다.
  - 폴스루 : break를 빼먹어 다음 블록이 실행되면서 버그가 발생하는 현상

```java
var forecastedAmount = amount * switch (dealStage) {
	case LEAD -> 0.2;
	case EVALUATING -> 0.5;
	case INTERESTED -> 0.8;
	case CLOSED -> 1;
}
```

- 가독성 좋아진다.

- 소모 검사가 이루어진다.





# 5.6 인터페이스 분리 원칙(ISP)

- 어떤 클래스도 사용하지 않는 메소드에 의존성을 갖지 않아야 한다. -> 불필요한 결합을 만든다.
- 인터페이스가 커지면 인터페이스 사용자는 사용하지 않는 기능을 갖게 되어 불필요한 결합도를 만든다.
- 독자적인 작은 개념으로 쪼개야 한다. -> 응집도가 높아진다.





# 5.7 플루언트 API 설계

**5.7.1 플루언트 API**

- 특정 문제를 더 직관적으로 해결할 수 있도록 특정 도메인에 맞춰진 API
- 메소드 체이닝(method chaining)을 이용해 더 복잡한 연산도 지정 가능하다.
- ex) Stream API, Spring Integeration, jOOQ



**5.6.2 도메인 모델링**

- 어떤 조건이 주어졌을 때, 이런 작업을 한다.
- 조건 : 어떤 팩트에 적용할 조건(참이나 거짓으로 평가됨)
- 액션 : 실행할 연산이나 코드 집합.
- 규칙 : 조건과 액션을 합친 것. 조건이 참일 때만 액션을 실행한다.





# 5.8 빌더 패턴

- 객체를 만드는 방법을 제공한다.
- 생성자의 파라미터를 분해해서 각각의 파라미터를 받는 여러 메소드로 분리한다.
